---
title: "Politics distance computation"
author: "Mattia Egloff"
date: "18/03/2020"
output: pdf_document
output_dir: "../../simdiversity-data/outputs/politics/"    
params:
  datasets:
    - "swiss_legislator_49"
    - "swiss_legislator_50"
    - "italian_legislator_17"
    - "italian_legislator_18"
  selected_dataset: 1
  selected_option: 2
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries and variables}
library(tidyverse)
library(simdiversity.data.politics)
library(simdiversity.RNcEDGPS)

```

```{r load data}
data_set_name <- params$datasets[[params$selected_dataset]]
data_set <- load_as_dataset(data_set_name)
```


The values of the data are coded as follows:

0. "Nein", "Non", "No"
1. "Ja", "Oui", "Si"
2. "Enthaltung", "Abstention", "Astensione"
3. "Der Pr??sident stimmt nicht", "Pr??sident ne vote pas", "Presidente non voto"
4. "Entschuldigt", "Excus??", "Scusato"
5. "Not avilable": means that the councillor is not part of the council.
6. "Hat nicht teilgenommen", "N'a pas particip??" "Non ha partecipato"

## Handle values that are not votes *per se*

The handeling of values other than "Yes" or "No" can be done by different means:

1. Everything that is not a vote is NA
2. Abstentions, Persidential non - vote, and excused are set to .5, absences and NA are set to NA.


###

1. Only real votes count
2. Abstentions, Persidential non - vote, are set to 0.5
3. Abstentions, Persidential non - vote, and excused are set to 0.5
```{r to NA}

```



```{r number of complete cases and percentage of NA, fig.width=12, fig.height=12}
scores_matrix %>% 
  complete.cases() %>% sum()
scores_matrix %>% 
  t() %>% complete.cases() %>% sum()
scores_matrix %>% 
  {sum(is.na(.)) * 100 / (nrow(.) * ncol(.))} %>% 
  round(digits = 2) %>% paste0("% of NA")
scores_matrix %>% 
  is.na() %>% {round(colSums(.)/nrow(.), 3)} %>% table %>%
  plot(xlab = "% missing in columns", ylab = "frequency")
scores_matrix %>% 
  is.na() %>% {round(rowSums(.)/ncol(.), 3)} %>% table %>%
  plot(xlab = "% missing in rows", ylab = "frequency")
```

```{r}
is_value <- factor(c("Yes", "No"))
data_set$scores %>%
  mutate_at(vars(-i_id), ~replace_na(., "NA")) %>%
  mutate_at(vars(-i_id), ~recode(., !!!score_codes)) %>%
  mutate_at(vars(-i_id), ~ifelse(is.na(.), 1, 2)) %>%
  pivot_longer(-i_id, names_to = "v_id", values_to = "element") %>%
  ggplot(aes(y = v_id, x = i_id, fill = is_value[element])) + 
  geom_tile(size = 20, width = 4) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  scale_fill_manual(values = c("black", "red")) +
  theme(axis.text.x = element_text(size = rel(.4), angle = 90)) +
  theme(axis.title.y = element_text(size = rel(.4), angle = 90)) +
  ggtitle("Hitmap NA values of scores_matrix")
```

## Dealing with NA

Remove all lines and columns that contain only NA

```{r find NAs, fig.show='hold', fig.width=12, fig.height=8, out.width="50%"}

null_votes_index = apply(scores_matrix, 2, function(x){all(is.na(x))})
null_councillors_index = apply(scores_matrix, 1, function(x){all(is.na(x))})
null_votes = c(names(  which(null_votes_index)))
null_councilors =  c(names(which(null_councillors_index)))
null_votes
null_councilors

scores_matrix <- scores_matrix[!null_councillors_index,!null_votes_index]
dim(scores_matrix)
n <- nrow( scores_matrix )
p <- ncol( scores_matrix )
```


```{r validity matrix, fig.show='hold', fig.width=12, fig.height=8, out.width="50%"}
weight <- validity.weight(scores_matrix)
if (any(weight == 0)) warning("Some weight are 0")
if (!sum(weight) == 1) warning("The sum of the weight is not 1")
hist(table(weight), main = "weight", xlab = "")
boxplot(weight, main = "weight")
```
Plot the vote variance

## Compute dissimilarities

#### Vote Disputedness


Plot vote disputedness:
```{r vote disputedness,  fig.show='hold', fig.width=12, fig.height=8, out.width="50%"}
hist(table(weighted_vote_disputedness),
     main = "Weighted vote disputedness", xlab = ""
)
boxplot(weighted_vote_disputedness,
        main = "Weighted vote disputedness")

```


```{r final dissimilarity, fig.width=12, fig.height=12}

D_final <- estimate.distance(scores_matrix, weight, weighted_vote_disputedness)
```

```{r save data}
usethis::use_data(D_final)
file_move(here("data", "D_final.rds"), here("data", paste0(data_set_name, "-D_final.rds")))
usethis::use_data(weight)
file_move(here("data", "weight.rds"), here("data", paste0(data_set_name, "-weight.rds")))
usethis::use_data(weighted_vote_disputedness)
file_move(here("data", "weighted_vote_disputedness.rds"), here("data", paste0(data_set_name, "-weighted_vote_disputedness.rds")))
```


```{r clean, include=FALSE}
rm(list = ls(all.names = TRUE))
gc()
gc()
```
